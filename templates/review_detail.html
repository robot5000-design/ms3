{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="row">
        <div class="col">
            <a href="#" class="btn btn-secondary go-back">Cancel & Go Back</a>
        </div>
    </div>
    {% if "user" in session %}
    {% if session["user"].lower() == "admin" %}
    <div class="row">
        <div class="btn btn-primary col-4 call-delete">Delete Entry
        </div>
        <a href="{{ url_for('delete_all', tmdb_id=movie_detail.tmdb_id) }}"
            class="btn btn-danger confirm-delete col-4 offset-4 d-none">Confirm Delete
        </a>
    </div>
    {% endif %}
    {% endif %}
    <div class="row">
        <h1 class="">Reviews for:</h1>
        <div>
            <h2 class="heading">{{ movie_detail.original_title }}</h2>

            {% if movie_detail.release_date == "" %}
            <div>Released: Not available.</div>
            {% else %}
            <div>Released: {{ movie_detail.release_date }}</div>
            {% endif %}
            <div>Overall Rating: {{ overall_rating }} / 5</div>

            {% if movie_detail.poster_path == None %}
            <img src="{{ url_for('static', filename='images/no-image-icon.png') }}" class="review-image" alt="">
            {% else %}
            <img src="{{ tmdb_poster_url }}{{ movie_detail.poster_path }}" class="review-image" alt="">
            {% endif %}
        </div>
        {% if not session.user %}
        <a class="login-modal" href="#" data-bs-toggle="modal" data-bs-target="#logInModal">Please Log-In to submit a
            Review</a>
        {% elif already_reviewed %}
        <div>You've already reviewed this.</div>
        {% else %}
        <a href="{{ url_for('new_review', tmdb_id=movie_detail.tmdb_id, media_type=movie_detail.media_type) }}"
            class="btn btn-primary">Review This</a>
        {% endif %}
        {% if reviews %}
        <div class="row">
            <div class="dropdown col">
                {% if review_detail_sort == "latest" %}
                <div class="btn btn-secondary dropdown-toggle" id="dropdownMenuLink" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Sort by: Latest
                </div>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('review_detail', tmdb_id=movie_detail.tmdb_id, media_type=movie_detail.media_type, review_detail_sort='popular', page=0) }}">
                            Sort by: Most Popular
                        </a>
                    </li>
                </ul>
                {% elif review_detail_sort == "popular" %}
                <div class="btn btn-secondary dropdown-toggle" id="dropdownMenuLink" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Sort by: Most Popular
                </div>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                    <li><a class="dropdown-item"
                            href="{{ url_for('review_detail', tmdb_id=movie_detail.tmdb_id, media_type=movie_detail.media_type, review_detail_sort='latest', page=0) }}">
                            Sort by: Latest
                        </a>
                    </li>
                </ul>
                {% endif %}
            </div>
        </div>

        <hr>
        {% for review in reviews %}
        {% if "user" in session %}
        {% if session["user"].lower() == "admin" %}
        <div class="row">
            <a class="btn btn-primary call-delete col-3">
                Delete This Review
            </a>
            <a href="{{ url_for('delete_review', tmdb_id=movie_detail.tmdb_id, user=review.created_by) }}"
                class="btn btn-danger confirm-delete d-none offset-3 col-3">Confirm Delete
            </a>
        </div>
        {% endif %}
        {% endif %}
        <div>
            Reviewed by: <a
                href="{{ url_for('my_reviews', user=review.created_by, my_reviews_sort='latest', page=0) }}">{{ review.created_by }}</a>
            {{ review.review_date }}
        </div>
        <div>{{ review.review }}</div>
        <div>Genre: {{ review.genre }}</div>
        <div>Rating: {{ review.rating }} / 5</div>
        {% if "user" in session and session["user"] != review.created_by and session["user"] not in review.likes %}
        <a href="{{ url_for('add_like', id=review._id, tmdb_id=review.tmdb_id, media_type=movie_detail.media_type) }}"><i class="fas fa-thumbs-up"></i>
            {{ review.likes | length }}</a>
        {% else %}
        <div><i class="fas fa-thumbs-up"></i> {{ review.likes|length }}</div>
        {% endif %}
        <hr>
        {% endfor %}
        <div class="row mx-auto pt-3">
            <div class="col">
                {% if review_count > 6 %}
                <div class="page-number">Page {{ page + 1 }} / {{ total_pages }}</div>
                {% endif %}
            </div>
        </div>
        <div class="row mx-auto">
            <div class="col">
                {% if page > 0 %}
                <a href="{{ url_for('review_detail', tmdb_id=movie_detail.tmdb_id, media_type=movie_detail.media_type, review_detail_sort=review_detail_sort, page=page-1) }}"
                    class="btn btn-secondary previous-button">Previous</a>
                {% endif %}
                {% if (review_count > 6) and ((page + 1) < (review_count / 6)) %}
                <a href="{{ url_for('review_detail', tmdb_id=movie_detail.tmdb_id, media_type=movie_detail.media_type, review_detail_sort=review_detail_sort, page=page+1) }}"
                    class="btn btn-secondary next-button">Next</a>
                {% endif %}
            </div>
        </div>
        {% else %}
        <h3>No reviews found</h3>
        {% endif %}
    </div>
</div>
{% endblock %}